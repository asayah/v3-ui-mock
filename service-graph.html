<!--
    Usecase: Global Service Failover Monitoring and Restoration
    
    This page represents the view that Cesar, the Platform Engineer, would see when a failover is in progress.

    - The graph shows that traffic from the "Internet" is no longer flowing to "us-east-1" (0%).
    - The traffic is now flowing to "us-west-2" (60%) and "eu-central-1" (40%).
    - The 'checkout (primary)' service in 'us-east-1' is highlighted in red, indicating it's the source of the failover.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Graph - Solo Enterprise</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --graph-bg: #0D1117;
            --panel-bg: #161B22;
            --border-color: #30363d;
        }
        .main-content {
            display: flex;
            height: calc(100vh - 60px); /* Adjust based on top-bar height */
            padding: 0;
            margin: 0;
        }
        .graph-container {
            flex-grow: 1;
            position: relative;
        }
        #cy {
            width: 100%;
            height: 100%;
            background-color: var(--graph-bg);
        }
        .filter-sidebar {
            width: 280px;
            background-color: var(--bg-card);
            border-left: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            color: var(--text-secondary);
        }
        .filter-group {
            margin-bottom: 24px;
        }
        .filter-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        .filter-input {
            width: 100%;
            background-color: var(--bg-dark);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.9rem;
            margin-bottom: 12px;
        }
        .filter-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .checkbox-label input {
            margin-right: 8px;
            accent-color: var(--accent);
        }
        .details-panel {
            position: absolute;
            right: -400px; /* Initially hidden */
            top: 20px;
            bottom: 20px;
            width: 400px;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            transition: right 0.3s ease-in-out;
            z-index: 100;
            padding: 20px;
            color: var(--text-primary);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .details-panel.visible {
            right: 20px;
        }
        .details-header {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .workload-list {
            flex-grow: 1;
            overflow-y: auto;
        }
        .workload-item {
            background-color: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            transition: border-color 0.2s;
        }
        .workload-item:hover {
            border-color: var(--accent);
        }
        .workload-item.down {
            border-left: 4px solid var(--color-error);
            background-color: var(--color-error-bg);
        }
        .workload-name {
            font-weight: 600;
        }
        .workload-details {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        .graph-top-bar {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 50;
            display: flex;
            gap: 12px;
        }

        .details-panel {
            font-size: 0.85rem;
        }
        .details-section {
            margin-bottom: 20px;
        }
        .details-section-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            font-size: 0.95rem;
        }
        
        .chart-container {
            position: relative;
            height: 150px;
            margin-bottom: 20px;
        }

        .auth-policy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .auth-policy-search {
            width: 60%;
            background-color: var(--bg-dark);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.8rem;
        }
        
        .auth-policy-item {
            background-color: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .auth-policy-item-header {
            padding: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .auth-policy-name {
            font-weight: 600;
        }

        .auth-policy-item-header i {
            transition: transform 0.2s;
        }

        .auth-policy-item.expanded .auth-policy-item-header i {
            transform: rotate(90deg);
        }

        .auth-policy-details {
            display: none;
            padding: 0 12px 12px;
        }

        .auth-policy-item.expanded .auth-policy-details {
            display: block;
        }

        .auth-policy-details pre {
            background-color: #161B22;
            color: #C9D1D9;
            padding: 10px;
            border-radius: 6px;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 0.75rem;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
        }

        .pagination button {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 8px;
            margin: 0 4px;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: #1e1e1e;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .modal-header h2 {
            margin: 0;
            font-size: 1.1rem;
        }
        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }
        .modal-content pre {
            flex-grow: 1;
            overflow-y: auto;
            margin: 0;
            padding: 20px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            background-color: #161B22;
            color: #C9D1D9;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="logo-area">
                <div class="logo-subtitle">SOLO ENTERPRISE FOR</div>
                <div class="logo-main">Istio</div>
            </div>
            <nav class="nav-menu">
                <a href="index.html" class="nav-item"><i class="fa-solid fa-table-columns"></i><span>Dashboard</span></a>
                <a href="#" class="nav-item"><i class="fa-solid fa-arrow-down-up-across-line"></i><span>Traffic</span></a>
                <a href="global-services.html" class="nav-item"><i class="fa-solid fa-globe"></i><span>Global Services</span></a>
                <a href="resources.html" class="nav-item"><i class="fa-solid fa-cubes"></i><span>Resources</span></a>
                <a href="service-graph.html" class="nav-item active"><i class="fa-solid fa-diagram-project"></i><span>Service Graph</span></a>
            </nav>
        </aside>

        <div class="main-content">
            <div class="graph-container">
                <div class="graph-top-bar">
                     <div class="breadcrumbs"><i class="fa-solid fa-diagram-project"></i> &nbsp; / &nbsp; <span>Graph</span></div>
                </div>
                <div id="cy"></div>

            </div>
            <aside class="filter-sidebar">
                <div class="filter-group">
                    <div class="filter-title">Search</div>
                    <input type="text" id="search-input" class="filter-input" placeholder="e.g., checkout-service">
                </div>
                <div class="filter-group">
                    <div class="filter-title">Clusters</div>
                    <div id="cluster-filters"></div>
                </div>
                <div class="filter-group">
                    <div class="filter-title">Namespaces</div>
                    <div id="namespace-filters"></div>
                </div>
                <div class="filter-group">
                    <div class="filter-title">App Labels</div>
                    <div id="label-filters" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
            </aside>

            <div id="details-panel" class="details-panel">
                <div id="details-header" class="details-header"></div>
                <div id="details-content" class="details-content"></div>
            </div>

            <div id="yaml-modal" class="modal-overlay" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="yaml-title"></h2>
                        <button id="close-yaml-modal" class="close-btn">&times;</button>
                    </div>
                    <pre id="yaml-content"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        const generateTimeSeriesData = () => {
            const labels = [];
            const data = [];
            for (let i = 0; i < 10; i++) {
                labels.push(`-0m${i*10}s`);
                data.push(Math.random() * 100);
            }
            return { labels, data };
        };

        const elements = {
            nodes: [
                // Traffic Source
                { data: { id: 'traffic-source', label: 'Internet Traffic', type: 'webapp' } },

                // Cluster parent nodes
                { data: { id: 'us-east-1', label: 'us-east-1' } },
                { data: { id: 'us-west-2', label: 'us-west-2' } },
                { data: { id: 'eu-central-1', label: 'eu-central-1' } },

                // Service nodes
                { data: { 
                    id: 'checkout-us-east-1', label: 'checkout (primary)', parent: 'us-east-1', type: 'service-failover',
                    workloads: [ { id: 'checkout-w1', name: 'checkout-v1-pod1', status: 'down'} ],
                } },
                { data: { 
                    id: 'checkout-us-west-2', label: 'checkout (failover)', parent: 'us-west-2', type: 'service' 
                } },
                 { data: { 
                    id: 'checkout-eu-central-1', label: 'checkout (failover)', parent: 'eu-central-1', type: 'service' 
                } },

                // Dependent services
                { data: { id: 'payment-service', label: 'Payment Service', parent: 'us-east-1', type: 'service' } },
                { data: { id: 'inventory-service', label: 'Inventory Service', parent: 'us-west-2', type: 'service' } },

            ],
            edges: [
                // Failover path
                { data: { source: 'traffic-source', target: 'checkout-us-east-1', label: '0%', state: 'down' } },
                { data: { source: 'traffic-source', target: 'checkout-us-west-2', label: '60%', state: 'up' } },
                { data: { source: 'traffic-source', target: 'checkout-eu-central-1', label: '40%', state: 'up' } },

                // Backend service connections
                { data: { source: 'checkout-us-east-1', target: 'payment-service' } },
                { data: { source: 'checkout-us-west-2', target: 'inventory-service' } },
                { data: { source: 'checkout-eu-central-1', target: 'inventory-service' } },
            ]
        };
        var cy = cytoscape({
            container: document.getElementById('cy'),
            elements: elements,
            style: [
                {
                    selector: 'node',
                    style: {
                        'background-color': '#2B313C',
                        'border-width': 2,
                        'border-color': '#58A6FF',
                        'label': 'data(label)',
                        'color': '#C9D1D9',
                        'font-size': 14,
                        'text-valign': 'bottom',
                        'text-margin-y': 8,
                        'width': 50,
                        'height': 50,
                    }
                },
                {
                    selector: '[type = "webapp"]',
                    style: {
                        'shape': 'rectangle',
                    }
                },
                {
                    selector: ':parent',
                    style: {
                        'background-color': '#161B22',
                        'border-color': '#30363d',
                        'label': 'data(label)',
                        'text-valign': 'top',
                        'text-halign': 'center',
                        'color': '#C9D1D9',
                        'font-size': 18,
                        'font-weight': 'bold',
                        'padding': '10px'
                    }
                },
                {
                    selector: '[type = "service-failover"]',
                    style: {
                        'border-color': 'var(--color-error)',
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 2.5,
                        'line-color': '#484F58',
                        'target-arrow-color': '#484F58',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier',
                        'label': 'data(label)',
                        'color': '#C9D1D9',
                        'font-size': 12,
                        'text-background-color': '#0D1117',
                        'text-background-opacity': 1,
                        'text-background-padding': '3px',
                    }
                },
                {
                    selector: 'edge[state = "down"]',
                    style: {
                        'line-color': 'var(--color-error)',
                        'target-arrow-color': 'var(--color-error)',
                        'line-style': 'dashed',
                    }
                },
                {
                    selector: 'edge[state = "up"]',
                    style: {
                        'line-color': 'var(--color-success)',
                        'target-arrow-color': 'var(--color-success)',
                        'width': 4,
                    }
                },
                {
                    selector: '.expanded-path',
                     style: {
                        'line-color': '#F59E0B',
                        'target-arrow-color': '#F59E0B',
                        'transition-property': 'line-color, target-arrow-color',
                        'transition-duration': '0.3s'
                    }
                }
            ],
            layout: {
                name: 'cose',
                animate: false,
                idealEdgeLength: 150,
                nodeRepulsion: 800000,
                edgeElasticity: 100,
                nestingFactor: 5,
                gravity: 80,
                numIter: 1000,
                initialTemp: 200,
                coolingFactor: 0.95,
                minTemp: 1.0
            }
        });

        // Filtering logic
        const searchInput = document.getElementById('search-input');
        const clusterFilters = document.getElementById('cluster-filters');
        const namespaceFilters = document.getElementById('namespace-filters');
        const labelFilters = document.getElementById('label-filters');
        
        const clusters = [...new Set(cy.nodes().map(n => n.data('parent')))].filter(Boolean);
        clusterFilters.innerHTML = clusters.map(c => c ? `<label class="checkbox-label"><input type="checkbox" value="${c}" checked> ${c}</label>` : '').join('');


        const debounce = (fn, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => fn(...args), delay);
            };
        };

        const applyFilters = () => {
            const searchText = searchInput.value.toLowerCase();
            const checkedClusters = [...clusterFilters.querySelectorAll('input:checked')].map(cb => cb.value);

            cy.nodes().forEach(node => {
                const data = node.data();
                const isParent = !data.parent;
                const parentId = data.parent;

                let isVisible = true;

                if (searchText && data.label.toLowerCase().indexOf(searchText) === -1) {
                    isVisible = false;
                }

                // Show node if its parent cluster is checked, or if it's a parent itself
                if (parentId) {
                    if (!checkedClusters.includes(parentId)) {
                        isVisible = false;
                    }
                }
                
                if (isVisible) {
                    node.style('display', 'element');
                } else {
                    node.style('display', 'none');
                }
            });
        };


        searchInput.addEventListener('keyup', debounce(applyFilters, 300));
        clusterFilters.addEventListener('change', applyFilters);

        const detailsPanel = document.getElementById('details-panel');
        const detailsHeader = document.getElementById('details-header');
        const detailsContent = document.getElementById('details-content');

        cy.on('tap', 'node', function(evt){
            const node = evt.target;
            const data = node.data();
            
            if (!data.type) return; // Don't show panel for parent nodes

            detailsHeader.innerHTML = `<i class="fa-solid fa-cube"></i> ${data.label}`;
            
            let content = '';

             if (data.workloads) {
                content += `
                    <div class="details-section">
                        <div class="details-section-title">Workloads</div>
                        <div class="workload-list">
                            ${data.workloads.map(w => `
                                <div class="workload-item ${w.status === 'down' ? 'down' : ''}">
                                    <div class="workload-name">${w.name}</div>
                                    <div class="workload-details">${w.status.toUpperCase()}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            detailsContent.innerHTML = content;
            detailsPanel.classList.add('visible');
        });

        cy.on('tap', function(event){
          if (event.target === cy) {
            detailsPanel.classList.remove('visible');
          }
        });

        // Animate edges
        let offset = 0;
        function animateEdges() {
            offset++;
            cy.edges().style({
                'line-dash-pattern': [10, 5],
                'line-dash-offset': -offset
            });
            requestAnimationFrame(animateEdges);
        }
        animateEdges();
    </script>
</body>
</html>